# 第一章：词法分析

## 目录

- [1.1 词法分析简介](#11-词法分析简介)
- [1.2 定义词法单元](#12-定义词法单元)
- [1.3 实现词法分析器](#13-实现词法分析器)
- [1.4 扩展词法单元集](#14-扩展词法单元集)
- [1.5 完整示例](#15-完整示例)

## 1.1 词法分析简介

词法分析（Lexical Analysis）是编译器或解释器的第一步。它的任务是将源代码字符串转换为一系列的 **词法单元**（Token）。

### 什么是词法单元？

词法单元（Token）是源代码中有意义的最小单位。比如在这段 Monkey 代码中：

```monkey
let x = 5 + 5;
```

词法分析器会识别出以下词法单元：

- `let` - 关键字
- `x` - 标识符
- `=` - 赋值运算符
- `5` - 整数字面量
- `+` - 加法运算符
- `5` - 整数字面量
- `;` - 分号

### 为什么需要词法分析？

1. **简化后续处理**：将原始字符串转换为结构化的词法单元，便于语法分析器处理
2. **提高效率**：一次性处理所有字符识别，避免重复工作
3. **错误检测**：及早发现非法字符
4. **代码组织**：将字符级别的处理与语法级别的处理分离

## 1.2 定义词法单元

首先，我们需要定义词法单元的结构和所有可能的词法单元类型。

### 词法单元接口

```typescript
/**
 * Token接口
 * 表示一个词法单元，包含类型和字面量值
 */
export interface Token {
  Type: TokenType;    // Token的类型
  Literal: string;    // Token的字面量值（源代码中的原始字符串）
}
```

每个 Token 包含两个字段：

- **Type**：Token 的类型（如 `IDENT`、`INT`、`PLUS` 等）
- **Literal**：Token 在源代码中的原始字符串

### 词法单元类型定义

```typescript
/**
 * TokenType类型
 * 使用字符串字面量类型来定义所有可能的Token类型
 */
export type TokenType = string;
```

### 词法单元类型常量

Monkey 语言支持以下词法单元类型：

#### 特殊类型

```typescript
export const ILLEGAL = "ILLEGAL";  // 非法字符
export const EOF = "EOF";          // 文件结束标记
```

#### 标识符和字面量

```typescript
export const IDENT = "IDENT";      // 标识符：add, foobar, x, y
export const INT = "INT";          // 整数：1343456
export const STRING = "STRING";    // 字符串："foobar"
```

#### 运算符

```typescript
export const ASSIGN = "=";         // 赋值
export const PLUS = "+";           // 加法
export const MINUS = "-";          // 减法
export const BANG = "!";           // 逻辑非
export const ASTERISK = "*";       // 乘法
export const SLASH = "/";          // 除法

export const LT = "<";             // 小于
export const GT = ">";             // 大于

export const EQ = "==";            // 相等
export const NOT_EQ = "!=";        // 不等
```

#### 分隔符

```typescript
export const COMMA = ",";          // 逗号
export const SEMICOLON = ";";      // 分号
export const COLON = ":";          // 冒号

export const LPAREN = "(";         // 左圆括号
export const RPAREN = ")";         // 右圆括号
export const LBRACE = "{";         // 左花括号
export const RBRACE = "}";         // 右花括号
export const LBRACKET = "[";       // 左方括号
export const RBRACKET = "]";       // 右方括号
```

#### 关键字

```typescript
export const FUNCTION = "FUNCTION"; // fn
export const LET = "LET";          // let
export const TRUE = "TRUE";        // true
export const FALSE = "FALSE";      // false
export const IF = "IF";            // if
export const ELSE = "ELSE";        // else
export const RETURN = "RETURN";    // return
```

### 关键字识别

我们需要区分标识符和关键字。例如，`let` 是关键字而不是普通标识符。

```typescript
/**
 * 关键字映射表
 */
const keywords: Record<string, TokenType> = {
  "fn": FUNCTION,
  "let": LET,
  "true": TRUE,
  "false": FALSE,
  "if": IF,
  "else": ELSE,
  "return": RETURN,
};

/**
 * 查找标识符的类型
 */
export function lookupIdent(ident: string): TokenType {
  const tokenType = keywords[ident];
  if (tokenType !== undefined) {
    return tokenType;
  }
  return IDENT;
}
```

## 1.3 实现词法分析器

现在我们来实现 `Lexer` 类，它负责将源代码字符串转换为词法单元流。

### Lexer 类的结构

```typescript
export class Lexer {
  private input: string;        // 输入的源代码字符串
  private position: number;     // 当前字符的位置
  private readPosition: number; // 下一个字符的位置
  private ch: string;           // 当前正在检查的字符

  constructor(input: string) {
    this.input = input;
    this.position = 0;
    this.readPosition = 0;
    this.ch = "";
    this.readChar(); // 初始化
  }
}
```

### 核心方法

详细的实现请参考源代码：[lexer.ts](../src/monkey/lexer/lexer.ts)

## 1.4 扩展词法单元集

随着语言的发展，我们可能需要添加新的词法单元类型。

## 1.5 完整示例

```typescript
import { Lexer } from "./lexer/lexer";

const input = "let x = 5;";
const lexer = new Lexer(input);

let tok = lexer.nextToken();
while (tok.Type !== "EOF") {
  console.log(tok);
  tok = lexer.nextToken();
}
```

## 小结

在本章中，我们学习了：

1. **词法分析的概念**：将源代码转换为词法单元流
2. **词法单元的定义**：包括类型和字面量
3. **词法分析器的实现**：字符读取、识别各种词法单元类型
4. **扩展性**：如何添加新的词法单元类型

---

**下一章**：[第二章：语法分析](./02-parsing.md)

**源代码参考**：
- [token.ts](../src/monkey/token/token.ts)
- [lexer.ts](../src/monkey/lexer/lexer.ts)
